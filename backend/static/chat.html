<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Sales Agent - Web Chat</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .chat-container {
        width: 100%;
        max-width: 800px;
        height: 90vh;
        background: white;
        border-radius: 20px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .chat-header h2 {
        font-size: 20px;
        font-weight: 600;
      }

      .status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 14px;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        background: #4ade80;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: #f9fafb;
      }

      .message {
        margin-bottom: 16px;
        display: flex;
        gap: 12px;
      }

      .message.user {
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
      }

      .message.ai .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .message.user .message-avatar {
        background: #e5e7eb;
      }

      .message-content {
        max-width: 70%;
      }

      .message-bubble {
        padding: 12px 16px;
        border-radius: 16px;
        word-wrap: break-word;
      }

      .message.ai .message-bubble {
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .message.user .message-bubble {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .product-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px;
        margin-top: 12px;
      }

      .product-card {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        overflow: hidden;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .product-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
      }

      .product-image {
        width: 100%;
        height: 150px;
        background: linear-gradient(135deg, #667eea20 0%, #764ba220 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 48px;
      }

      .product-info {
        padding: 12px;
      }

      .product-name {
        font-weight: 600;
        font-size: 14px;
        margin-bottom: 4px;
      }

      .product-price {
        color: #667eea;
        font-weight: 600;
        font-size: 16px;
      }

      .product-reason {
        font-size: 12px;
        color: #6b7280;
        margin-top: 8px;
      }

      .quick-replies {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 12px;
      }

      .quick-reply-btn {
        padding: 8px 16px;
        background: #f3f4f6;
        border: 1px solid #e5e7eb;
        border-radius: 20px;
        cursor: pointer;
        font-size: 14px;
        transition: all 0.2s;
      }

      .quick-reply-btn:hover {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      .typing-indicator {
        display: none;
        padding: 12px 16px;
        background: white;
        border-radius: 16px;
        width: fit-content;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .typing-indicator.show {
        display: block;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: #9ca3af;
        border-radius: 50%;
        animation: bounce 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes bounce {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      .chat-input-container {
        padding: 20px;
        background: white;
        border-top: 1px solid #e5e7eb;
      }

      .chat-input-form {
        display: flex;
        gap: 12px;
      }

      .chat-input {
        flex: 1;
        padding: 12px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 24px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
      }

      .chat-input:focus {
        border-color: #667eea;
      }

      .send-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 24px;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s;
      }

      .send-btn:hover {
        transform: scale(1.05);
      }

      .send-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }
    </style>
  </head>
  <body>
    <div class="chat-container">
      <div class="chat-header">
        <h2>ðŸ¤– AI Sales Agent</h2>
        <div class="status">
          <span class="status-dot"></span>
          <span>Online</span>
        </div>
      </div>

      <div class="chat-messages" id="chatMessages">
        <div class="message ai">
          <div class="message-avatar">ðŸ¤–</div>
          <div class="message-content">
            <div class="message-bubble">
              Hi! ðŸ‘‹ I'm your AI shopping assistant. I can help you find the
              perfect items, check availability, and complete your purchase.
              What are you looking for today?
            </div>
          </div>
        </div>
      </div>

      <div class="chat-input-container">
        <form class="chat-input-form" id="chatForm">
          <input
            type="text"
            class="chat-input"
            id="messageInput"
            placeholder="Type your message..."
            autocomplete="off"
          />
          <button type="submit" class="send-btn" id="sendBtn">Send</button>
        </form>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:8000";
      let sessionId = null;
      const customerId = 1;

      // Get session ID from URL if present
      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get("session");

      async function initializeSession() {
        if (urlSessionId) {
          // Use session from URL
          sessionId = urlSessionId;
          console.log("Using session from URL:", sessionId);

          // Verify session exists
          try {
            const response = await fetch(`${API_URL}/session/${sessionId}`);
            const data = await response.json();
            if (data.success) {
              console.log("Session verified:", data.data);
            } else {
              console.log("Session not found, creating new one");
              await createNewSession();
            }
          } catch (error) {
            console.error("Session verification failed, creating new one");
            await createNewSession();
          }
        } else {
          await createNewSession();
        }
      }

      async function createNewSession() {
        try {
          const response = await fetch(
            `${API_URL}/session/create?customer_id=${customerId}&channel=web`,
            {
              method: "POST",
            }
          );
          const data = await response.json();
          if (data.success) {
            sessionId = data.session_id;
            console.log("Session initialized:", sessionId);
          }
        } catch (error) {
          console.error("Failed to initialize session:", error);
        }
      }

      function addMessage(text, isUser = false, extraContent = null) {
        const messagesContainer = document.getElementById("chatMessages");

        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isUser ? "user" : "ai"}`;

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = isUser ? "ðŸ‘¤" : "ðŸ¤–";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const bubble = document.createElement("div");
        bubble.className = "message-bubble";
        bubble.textContent = text;

        contentDiv.appendChild(bubble);

        if (extraContent) {
          contentDiv.appendChild(extraContent);
        }

        messageDiv.appendChild(avatar);
        messageDiv.appendChild(contentDiv);

        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function showTyping() {
        const messagesContainer = document.getElementById("chatMessages");

        const typingDiv = document.createElement("div");
        typingDiv.className = "message ai";
        typingDiv.id = "typingIndicator";

        const avatar = document.createElement("div");
        avatar.className = "message-avatar";
        avatar.textContent = "ðŸ¤–";

        const contentDiv = document.createElement("div");
        contentDiv.className = "message-content";

        const typing = document.createElement("div");
        typing.className = "typing-indicator show";
        typing.innerHTML = `
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        `;

        contentDiv.appendChild(typing);
        typingDiv.appendChild(avatar);
        typingDiv.appendChild(contentDiv);

        messagesContainer.appendChild(typingDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
      }

      function hideTyping() {
        const typing = document.getElementById("typingIndicator");
        if (typing) typing.remove();
      }

      function createProductCards(products) {
        if (!products || products.length === 0) return null;

        const container = document.createElement("div");
        container.className = "product-cards";

        products.forEach((product) => {
          const card = document.createElement("div");
          card.className = "product-card";
          card.onclick = () => addToCart(product.product_id);

          card.innerHTML = `
                <div class="product-image">ðŸ‘—</div>
                <div class="product-info">
                    <div class="product-name">${product.name}</div>
                    <div class="product-price">$${product.price}</div>
                    ${
                      product.reason
                        ? `<div class="product-reason">${product.reason}</div>`
                        : ""
                    }
                </div>
            `;

          container.appendChild(card);
        });

        return container;
      }

      function createQuickReplies(replies) {
        if (!replies || replies.length === 0) return null;

        const container = document.createElement("div");
        container.className = "quick-replies";

        replies.forEach((reply) => {
          const btn = document.createElement("button");
          btn.className = "quick-reply-btn";
          btn.textContent = reply.text || reply;
          btn.onclick = () => sendMessage(reply.text || reply);
          container.appendChild(btn);
        });

        return container;
      }

      async function sendMessage(text) {
        const input = document.getElementById("messageInput");
        const sendBtn = document.getElementById("sendBtn");

        if (!text) text = input.value.trim();
        if (!text || !sessionId) {
          console.error("No text or session ID");
          return;
        }

        addMessage(text, true);
        input.value = "";
        sendBtn.disabled = true;

        showTyping();

        try {
          console.log("Sending message with session:", sessionId);
          const response = await fetch(
            `${API_URL}/channel-chat?message=${encodeURIComponent(
              text
            )}&channel=web&customer_id=${customerId}&session_id=${sessionId}`,
            {
              method: "POST",
            }
          );

          const data = await response.json();
          console.log("Response:", data);

          hideTyping();

          if (data.success) {
            const aiData = data.data;

            let extraContent = document.createElement("div");

            if (aiData.product_cards) {
              const cards = createProductCards(aiData.product_cards);
              if (cards) extraContent.appendChild(cards);
            }

            if (aiData.quick_replies) {
              const replies = createQuickReplies(aiData.quick_replies);
              if (replies) extraContent.appendChild(replies);
            }

            addMessage(
              aiData.message,
              false,
              extraContent.children.length > 0 ? extraContent : null
            );
          } else {
            addMessage(
              "Sorry, I encountered an error. Please try again.",
              false
            );
          }
        } catch (error) {
          hideTyping();
          console.error("Error:", error);
          addMessage("Sorry, I could not process your request.", false);
        } finally {
          sendBtn.disabled = false;
        }
      }

      async function addToCart(productId) {
        if (!sessionId) {
          console.error("No session ID");
          return;
        }

        console.log("Adding to cart:", productId, "Session:", sessionId);

        try {
          const response = await fetch(`${API_URL}/cart/add`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              session_id: sessionId,
              product_id: productId,
              quantity: 1,
            }),
          });

          const data = await response.json();
          console.log("Cart add response:", data);

          if (data.success) {
            addMessage(
              `âœ… Added to cart! You now have ${data.total_items} items.`,
              false
            );
          } else {
            addMessage(
              `âŒ Failed to add to cart: ${data.message || "Unknown error"}`,
              false
            );
          }
        } catch (error) {
          console.error("Error adding to cart:", error);
          addMessage("âŒ Error adding to cart", false);
        }
      }

      document.getElementById("chatForm").addEventListener("submit", (e) => {
        e.preventDefault();
        sendMessage();
      });

      initializeSession();
    </script>
  </body>
</html>
